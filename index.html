import React, { useEffect, useMemo, useRef, useState } from "react";
return { id: (id||`S${i+1}`).trim(), name: (name||"").trim(), present: false };
}).filter(s => s.name || s.id);
if (parsed.length) setStudents(parsed);
};
reader.readAsText(file);
}


return (
<div className="min-h-screen bg-slate-50 p-6">
<div className="max-w-6xl mx-auto flex flex-col gap-6">
<header className="flex items-center justify-between">
<h1 className="text-2xl font-bold tracking-tight flex items-center gap-2"><QrCode className="w-6 h-6"/> Control de asistencia por QR</h1>
<div className="flex gap-2">
<button onClick={downloadCSVSummary} className="px-3 py-2 rounded-2xl shadow border bg-white hover:bg-slate-100 flex items-center gap-2"><Download className="w-4 h-4"/> Exportar resumen</button>
<button onClick={resetAll} className="px-3 py-2 rounded-2xl shadow border bg-white hover:bg-slate-100 flex items-center gap-2"><RefreshCw className="w-4 h-4"/> Reiniciar</button>
</div>
</header>


<div className="grid md:grid-cols-2 gap-6">
<Section title="Escáner QR">
<div className="flex flex-col gap-3">
<div className="flex flex-wrap items-center gap-2">
<select value={cameraId ?? ''} onChange={e => setCameraId(e.target.value)} className="px-3 py-2 border rounded-xl bg-white">
{cameras.map(c => <option key={c.id} value={c.id}>{c.label || c.id}</option>)}
</select>
{!scannerOn ? (
<button onClick={() => setScannerOn(true)} className="px-3 py-2 rounded-2xl shadow border bg-white hover:bg-slate-100 flex items-center gap-2"><Camera className="w-4 h-4"/> Iniciar cámara</button>
) : (
<button onClick={() => setScannerOn(false)} className="px-3 py-2 rounded-2xl shadow border bg-white hover:bg-slate-100 flex items-center gap-2"><CameraOff className="w-4 h-4"/> Detener</button>
)}
</div>
<div id="qr-reader" className="overflow-hidden rounded-2xl border bg-black/5 aspect-square" />
{lastScan && (
<p className="text-sm text-slate-600">Último QR: <span className="font-mono">{lastScan}</span></p>
)}
{message && <p className="text-sm">{message}</p>}
<p className="text-xs text-slate-500">Formato admitido del QR: <code className="bg-slate-100 px-1 rounded">ID</code> o JSON <code className="bg-slate-100 px-1 rounded">{"{\"id\":\"A001\"}"}</code> o <code className="bg-slate-100 px-1 rounded">{"{\"name\":\"Ana López\"}"}</code>.</p>
</div>
</Section>


<Section title="Listado de alumnos">
<div className="flex items-center justify-between mb-2">
<div className="text-sm text-slate-700">Total: <b>{totals.total}</b> · Presentes: <b className="text-green-600">{totals.present}</b> · Ausentes: <b className="text-red-600">{totals.absent}</b></div>
<label className="px-3 py-2 rounded-2xl shadow border bg-white hover:bg-slate-100 cursor-pointer flex items-center gap-2">
<Upload className="w-4 h-4"/> Importar CSV
<input type="file" accept=".csv" className="hidden" onChange={e => e.target.files && e.target.files[0] && handleCSVUpload(e.target.files[0])} />
</label>
</div>


<div className="max-h-[420px] overflow-auto divide-y bg-white border rounded-2xl">
{students.map(s => (
<div key={s.id} className="flex items-center justify-between px-4 py-3">
<div>
<div className={`font-medium ${s.present ? "line-through text-slate-400" : ""}`}>{s.name}</div>
<div className="text-xs text-slate-500">ID: <span className="font-mono">{s.id}</span> {s.present && s.time ? `· ${s.time}` : ""}</div>
</div>
<button onClick={() => toggleManual(s.id)} className={`px-3 py-1 rounded-xl border shadow flex items-center gap-2 ${s.present ? "bg-green-50" : "bg-white"}`}>
{s.present ? <CheckCircle2 className="w-4 h-4"/> : <XCircle className="w-4 h-4"/>}
{s.present ? "Presente" : "Marcar"}
</button>
</div>
))}
</div>


<p className="text-xs text-slate-500 mt-3">Consejo: imprime o entrega a cada alumno un QR con su <b>ID</b>. Al escanear, se marcará automáticamente como presente.</p>
</Section>
</div>


<Section title="Resumen">
<div className="grid md:grid-cols-3 gap-3">
<div className="p-4 bg-green-50 border rounded-2xl">
<div className="text-sm text-slate-600">Presentes</div>
<div className="text-2xl font-bold">{totals.present}</div>
</div>
<div className="p-4 bg-red-50 border rounded-2xl">
<div className="text-sm text-slate-600">Ausentes</div>
<div className="text-2xl font-bold">{totals.absent}</div>
</div>
<div className="p-4 bg-slate-50 border rounded-2xl">
<div className="text-sm text-slate-600">Total</div>
<div className="text-2xl font-bold">{totals.total}</div>
</div>
</div>
<ul className="mt-4 text-sm list-disc pl-5">
<li>Puedes exportar el resumen a CSV con el botón "Exportar resumen".</li>
<li>Si un QR no coincide con ningún alumno, verás una advertencia.</li>
<li>También puedes marcar/desmarcar manualmente desde la lista.</li>
</ul>
</Section>


<footer className="text-xs text-slate-500 text-center mt-4">Hecho con React + html5-qrcode. Funciona en navegador moderno (HTTPS recomendado para acceso a cámara).</footer>
</div>
</div>
);
}
